#!/usr/bin/env php
<?php

require_once __DIR__ . '/../vendor/autoload.php';

/**
 * Transformation Rules test run
 */

use \WebPlatform\MediaWiki\Transformer\Tests\PagesFixture;
use \WebPlatform\MediaWiki\Transformer\Model;

$fixtures = new PagesFixture;

$wikitext = (string)$fixtures->getOne()->revision->text;

//die(var_dump($wikitext));

/*
$wikitext = <<<TEMPLATE
{{PAGE_TITLE}}
= Hi Dawg =

{{Flags
|State=Ready to Use
|Checked_Out=No
}}

== Stuff ==
TEMPLATE;
*/

$last_ones[] = array('/^\}\}$/mu',PHP_EOL."----");
$last_ones[] = array('/^\|Manual_sections\=.*/iu', '|Manual_sections='.PHP_EOL);
foreach($last_ones as $last){
	$wikitext = preg_replace($last[0], $last[1], $wikitext);
}

$rules = [];

$i1[] = '/^\{\{Page_Title.*$/imu';
$i1[] = '/^\{\{Page_Title\}\}.*$/imu';
$rules[] = new Model\Rule($i1);


$i2[] = '/\{\{(Flags)/ius';
$rules[] = new Model\Rule($i2, '## Page status {#${1}}'.PHP_EOL);


$i3[] = '/^\|(State)=(.*)$/imu';
$i3[] = '/^\|(Checked_Out)=(.*)$/imu';
$i3[] = '/^\|(Editorial(\s|_)notes)=(.*)$/imu';
$rules[] = new Model\Rule($i3, '| ${1} | ${2} |');


$rules[] = new Model\Rule($i4, PHP_EOL.'|Manual_sections='.PHP_EOL.'${1}');

foreach($rules as $rule){
	$wikitext = $rule->execute($wikitext);
}




var_dump($wikitext);
